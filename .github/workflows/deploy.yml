name: Build and Deploy Static Website

on:
  # æ¯å¤©å®šæ—¶è¿è¡Œï¼ˆUTCæ—¶é—´0ç‚¹ï¼ŒåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“æœ‰æ¨é€äº‹ä»¶æ—¶è§¦å‘
  push:
    branches: [ main, master ]
  # å½“æœ‰æ‹‰å–è¯·æ±‚äº‹ä»¶æ—¶è§¦å‘
  pull_request:
    branches: [ main, master ]

# è®¾ç½®æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

# å…è®¸å¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç åº“
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²ï¼Œä¾¿äºåç»­gitæ“ä½œ

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi

      # 4. æ·»åŠ æ„å»ºæ—¶é—´æˆ³ï¼ˆå¼ºåˆ¶CDNåˆ·æ–°ï¼‰
      - name: Add build timestamp
        run: |
          echo "BUILD_TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      # 5. è¿è¡Œæ„å»ºè„šæœ¬ç”Ÿæˆé™æ€æ–‡ä»¶
      - name: Generate static files
        run: |
          echo "å¼€å§‹æ„å»ºé™æ€æ–‡ä»¶..."
          python build_static.py
          echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la index.html || echo "index.html æœªç”Ÿæˆ"

      # 6. éªŒè¯æ„å»ºè¾“å‡º
      - name: Verify build output
        run: |
          if [ ! -f "index.html" ]; then
            echo "é”™è¯¯: index.html æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          echo "æ„å»ºéªŒè¯æˆåŠŸ"
          
          # åœ¨HTMLä¸­æ·»åŠ æ„å»ºæ ‡è¯†ï¼ˆå¼ºåˆ¶CDNåˆ·æ–°ï¼‰
          if grep -q "BUILD_ID" index.html; then
            echo "æ„å»ºæ ‡è¯†å·²å­˜åœ¨"
          else
            echo "æ„å»ºæ ‡è¯†ä¸å­˜åœ¨ï¼Œæ·»åŠ ä¸­..."
            sed -i 's|<head>|<head>\n<!-- BUILD_ID: ${{ env.BUILD_TIMESTAMP }} -->|' index.html
          fi

      # 7. é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 8. æäº¤æ›´æ”¹ï¼ˆä»…åœ¨mainåˆ†æ”¯æ¨é€æ—¶ï¼‰
      - name: Commit and push changes
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git status
          git add index.html *.jpg *.png *.css *.js 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ğŸš€ Automated build: ${{ env.BUILD_DATE }} [BUILD_ID:${{ env.BUILD_TIMESTAMP }}]"
            git push origin main
            echo "æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
          fi

      # 9. è®¾ç½®GitHub Pages
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      # 10. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  # éƒ¨ç½²åˆ°GitHub Pages
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
